name: PR Lifecycle â€” enforce changelog and request reviewers

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check changelog and request reviewers
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;
            const body = pr.body || '';

            // Check for changelog mention in PR body
            const hasChangelog = /changelog/i.test(body) || /CHANGELOG.md/.test(body);

            if (!hasChangelog) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['needs-changelog'] });
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: 'Please add a changelog entry or mention the change in the PR body. Labeling as `needs-changelog`.' });
            } else {
              // remove label if present
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: prNumber, name: 'needs-changelog' }); } catch (e) {}
            }

            // Request reviewers from CODEOWNERS if present
            try {
              const co = await github.rest.repos.getContent({ owner, repo, path: '.github/CODEOWNERS' });
              const content = Buffer.from(co.data.content, 'base64').toString();
              const m = content.match(/@([^\s,]+)/);
              if (m) {
                const reviewer = m[0];
                await github.rest.pulls.requestReviewers({ owner, repo, pull_number: prNumber, reviewers: [ reviewer.replace('@','') ] });
              }
            } catch (e) {
              // no CODEOWNERS or permission - ignore
            }
